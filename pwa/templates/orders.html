{% extends "base.html" %}

{% block title %}Orders - {{ data.restaurant_name }}{% endblock %}

{% block extra_css %}
<style>
    .orders-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    .order-filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .order-filters select, .order-filters input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .orders-list {
        display: grid;
        gap: 15px;
    }
    .order-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .order-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    .order-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 500;
    }
    .status-pending { background-color: #fffbeb; color: #d97706; }
    .status-preparing { background-color: #eff6ff; color: #1d4ed8; }
    .status-ready { background-color: #ecfdf5; color: #047857; }
    .status-completed { background-color: #f3f4f6; color: #4b5563; }
    .order-items {
        margin-top: 10px;
    }
    .order-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f3f4f6;
    }
    .order-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        justify-content: flex-end;
    }
    .btn {
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        border: none;
    }
    .btn-primary {
        background-color: #4f46e5;
        color: white;
    }
    .btn-outline {
        background: none;
        border: 1px solid #4f46e5;
        color: #4f46e5;
    }
    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        gap: 10px;
    }
    .pagination button {
        padding: 8px 12px;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
        border-radius: 4px;
    }
    .pagination button.active {
        background-color: #4f46e5;
        color: white;
        border-color: #4f46e5;
    }
</style>
{% endblock %}

{% block content %}
<div class="orders-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Orders</h1>
        <button class="btn btn-primary" onclick="location.href='/orders/new'">
            <i class="fas fa-plus"></i> New Order
        </button>
    </div>

    <div class="order-filters">
        <select id="status-filter" class="form-select" onchange="filterOrders()">
            <option value="">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="preparing">Preparing</option>
            <option value="ready">Ready</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
        </select>
        
        <input type="date" id="date-filter" class="form-control" onchange="filterOrders()">
        
        <input type="text" id="search" class="form-control" placeholder="Search orders..." onkeyup="filterOrders()">
    </div>

    <div class="orders-list">
        {% for order in orders %}
        <div class="order-card">
            <div class="order-header">
                <div>
                    <strong>Order #{{ order.id }}</strong>
                    <span class="ms-2 text-muted">Table {{ order.table_number }}</span>
                </div>
                <div>
                    <span class="order-status status-{{ order.status|lower }}">
                        {{ order.status|title }}
                    </span>
                </div>
            </div>
            
            <div class="order-meta mb-2">
                <small class="text-muted">
                    {{ order.created_at.strftime('%b %d, %Y %I:%M %p') }} • 
                    {{ order.items|length }} items • 
                    KSh {{ "%0.2f"|format(order.total_amount / 100) }}
                </small>
            </div>
            
            <div class="order-items">
                {% for item in order.items %}
                <div class="order-item">
                    <span>{{ item.quantity }}x {{ item.name }}</span>
                    <span>KSh {{ "%0.2f"|format(item.price / 100) }}</span>
                </div>
                {% endfor %}
            </div>
            
            <div class="order-actions">
                {% if order.status == 'pending' %}
                <button class="btn btn-primary btn-sm" onclick="updateOrderStatus({{ order.id }}, 'preparing')">
                    <i class="fas fa-utensils"></i> Start Preparing
                </button>
                {% elif order.status == 'preparing' %}
                <button class="btn btn-success btn-sm" onclick="updateOrderStatus({{ order.id }}, 'ready')">
                    <i class="fas fa-check"></i> Mark as Ready
                </button>
                {% elif order.status == 'ready' %}
                <button class="btn btn-secondary btn-sm" onclick="updateOrderStatus({{ order.id }}, 'completed')">
                    <i class="fas fa-check-double"></i> Mark as Served
                </button>
                {% endif %}
                
                <button class="btn btn-outline btn-sm" onclick="viewOrderDetails({{ order.id }})">
                    <i class="fas fa-eye"></i> View Details
                </button>
            </div>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <p class="text-muted">No orders found</p>
        </div>
        {% endfor %}
    </div>

    {% if orders and orders|length > 0 %}
    <div class="pagination">
        {% if page > 1 %}
        <button onclick="changePage({{ page - 1 }})">Previous</button>
        {% endif %}
        
        {% for p in range(1, total_pages + 1) %}
        <button 
            class="{% if p == page %}active{% endif }}" 
            onclick="changePage({{ p }})"
        >
            {{ p }}
        </button>
        {% endfor %}
        
        {% if page < total_pages %}
        <button onclick="changePage({{ page + 1 }})">Next</button>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set the default date to today
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date-filter').value = today;
    });

    function filterOrders() {
        const status = document.getElementById('status-filter').value;
        const date = document.getElementById('date-filter').value;
        const search = document.getElementById('search').value.toLowerCase();
        
        // Build query string
        let query = [];
        if (status) query.push(`status=${status}`);
        if (date) query.push(`date=${date}`);
        if (search) query.push(`search=${encodeURIComponent(search)}`);
        
        // Reload page with new filters
        window.location.href = `/orders?${query.join('&')}`;
    }

    function changePage(page) {
        const url = new URL(window.location.href);
        url.searchParams.set('page', page);
        window.location.href = url.toString();
    }

    function updateOrderStatus(orderId, newStatus) {
        if (!confirm('Are you sure you want to update this order status?')) {
            return;
        }
        
        fetch(`/api/orders/${orderId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('Failed to update order status: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the order status');
        });
    }

    function viewOrderDetails(orderId) {
        window.location.href = `/orders/${orderId}`;
    }
</script>
{% endblock %}
